<!--
  Wazuh Agent Configuration — ossec.conf
  Target:  Windows Server 2022 (monitored endpoint)
  Manager: 192.168.1.74 (Linux Mint host running Wazuh Docker)
  Version: Wazuh Agent 4.7.4

  Deploy to: C:\Program Files (x86)\ossec-agent\ossec.conf
  After editing, restart the service:
    Restart-Service WazuhSvc
-->

<ossec_config>

  <!-- ── Client / Manager Connection ─────────────────────────────
       Points the agent to the Wazuh manager running on the host.
       Protocol UDP 1514 is used for event forwarding.
       TCP 1515 is used for agent registration (enrollment).
       ──────────────────────────────────────────────────────────── -->
  <client>
    <server>
      <address>192.168.1.74</address>
      <port>1514</port>
      <protocol>tcp</protocol>
    </server>
    <config-profile>windows</config-profile>
    <notify_time>10</notify_time>
    <time-reconnect>60</time-reconnect>
    <auto_restart>yes</auto_restart>
    <crypto_method>aes</crypto_method>
  </client>

  <!-- ── Client Buffer (Anti-Flooding) ───────────────────────────
       Limits the rate at which the agent sends events to the
       manager. Prevents log bursts from overwhelming the indexer
       on resource-constrained hardware.
       ──────────────────────────────────────────────────────────── -->
  <client_buffer>
    <disabled>no</disabled>
    <queue_size>5000</queue_size>
    <events_per_second>500</events_per_second>
  </client_buffer>

  <!-- ── Windows Event Log Collection ────────────────────────────
       Monitors the Windows Security log for authentication events.
       Event ID 4625 (failed logon) is critical for brute-force
       detection. Event ID 4624 tracks successful logons.
       ──────────────────────────────────────────────────────────── -->
  <localfile>
    <location>Security</location>
    <log_format>eventchannel</log_format>
    <query>Event/System[EventID=4624 or EventID=4625 or EventID=4634 or EventID=4648 or EventID=4672 or EventID=4720 or EventID=4722 or EventID=4723 or EventID=4724 or EventID=4725 or EventID=4726]</query>
  </localfile>

  <!-- System log — tracks service starts/stops, driver loads -->
  <localfile>
    <location>System</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- Application log — catches application-level errors -->
  <localfile>
    <location>Application</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- Microsoft-Windows-Sysmon/Operational — if Sysmon is deployed -->
  <!-- Uncomment if Sysmon is installed on the endpoint:
  <localfile>
    <location>Microsoft-Windows-Sysmon/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>
  -->

  <!-- Windows Defender log -->
  <localfile>
    <location>Microsoft-Windows-Windows Defender/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- PowerShell Operational log — catches script block logging -->
  <localfile>
    <location>Microsoft-Windows-PowerShell/Operational</location>
    <log_format>eventchannel</log_format>
  </localfile>

  <!-- ── File Integrity Monitoring (FIM) ──────────────────────────
       Monitors critical Windows directories for unauthorized
       changes. Runs a real-time scan on Program Files and
       a scheduled scan every 12 hours on Windows directory.
       ──────────────────────────────────────────────────────────── -->
  <syscheck>
    <disabled>no</disabled>
    <frequency>43200</frequency>
    <scan_on_start>yes</scan_on_start>

    <!-- Real-time monitoring on high-value directories -->
    <directories check_all="yes" realtime="yes">%WINDIR%\System32\drivers</directories>
    <directories check_all="yes" realtime="yes">%WINDIR%\System32\wbem</directories>
    <directories check_all="yes" realtime="yes">%PROGRAMDATA%\Microsoft\Windows\Start Menu\Programs\Startup</directories>

    <!-- Scheduled monitoring -->
    <directories check_all="yes">%WINDIR%\System32</directories>
    <directories check_all="yes">%PROGRAMFILES%</directories>
    <directories check_all="yes">%PROGRAMFILES(X86)%</directories>

    <!-- Exclude noisy paths that change frequently -->
    <ignore>%WINDIR%\System32\LogFiles</ignore>
    <ignore>%WINDIR%\System32\wbem\Logs</ignore>
    <ignore type="sregex">.log$|.tmp$|.temp$</ignore>

    <!-- Skip symbolic links to avoid circular traversal -->
    <skip_nfs>yes</skip_nfs>
  </syscheck>

  <!-- ── Rootkit / Malware Detection ──────────────────────────────
       Scans for hidden processes, ports, and files using
       Wazuh's built-in rootcheck module.
       ──────────────────────────────────────────────────────────── -->
  <rootcheck>
    <disabled>no</disabled>
    <windows_apps>./shared/win_applications_rcl.txt</windows_apps>
    <windows_malware>./shared/win_malware_rcl.txt</windows_malware>
  </rootcheck>

  <!-- ── Security Configuration Assessment (SCA) ──────────────────
       Runs CIS Benchmark checks for Windows Server 2022.
       Results appear under the "SCA" tab in the Wazuh dashboard.
       ──────────────────────────────────────────────────────────── -->
  <sca>
    <enabled>yes</enabled>
    <scan_on_start>yes</scan_on_start>
    <interval>12h</interval>
    <skip_nfs>yes</skip_nfs>
  </sca>

  <!-- ── Active Response ──────────────────────────────────────────
       Allows the manager to send response commands back to the
       agent (e.g., run a firewall block script when a brute
       force rule fires). Requires active-response config on
       the manager side as well.
       ──────────────────────────────────────────────────────────── -->
  <active-response>
    <disabled>no</disabled>
    <ca_store>wpk_root.pem</ca_store>
    <ca_verification>yes</ca_verification>
  </active-response>

  <!-- ── Agent Labels ─────────────────────────────────────────────
       Custom metadata tags visible in the Wazuh dashboard.
       Useful for filtering agents by role or environment.
       ──────────────────────────────────────────────────────────── -->
  <labels>
    <label key="env">home-soc-lab</label>
    <label key="role">target-windows-server</label>
    <label key="os">Windows Server 2022</label>
    <label key="network">bridged-homesoc</label>
  </labels>

</ossec_config>
