<!-- ============================================================
     Wazuh Custom Rules — Home SOC Lab
     File:    local_rules.xml
     Author:  Jesus Gamez
     Purpose: Detect RDP brute-force attacks via Windows Event ID 4625
     Place:   /var/ossec/etc/rules/local_rules.xml (on Wazuh manager)

     MITRE ATT&CK Coverage:
       - T1110.001  Brute Force: Password Guessing
       - T1021.001  Remote Services: Remote Desktop Protocol

     After editing, reload rules without restarting the manager:
       docker exec -it wazuh-wazuh.manager-1 /var/ossec/bin/ossec-control reload
     ============================================================ -->

<group name="windows,authentication,brute_force,rdp">

  <!-- ──────────────────────────────────────────────────────────────
       Rule 100001 — Single RDP Failed Logon (Event ID 4625)
       Base rule: catches every individual failed logon event.
       This rule fires on its own but also serves as the parent
       for the frequency-based rule below.
       Level 5 = informational; will appear in dashboard but not
       trigger high-priority alerts on its own.
       ────────────────────────────────────────────────────────────── -->
  <rule id="100001" level="5">
    <if_group>windows</if_group>
    <field name="win.system.eventID">^4625$</field>
    <description>Windows: Failed RDP logon attempt - Event ID 4625. User: $(win.eventdata.targetUserName) Source: $(win.eventdata.ipAddress)</description>
    <options>no_full_log</options>
    <mitre>
      <id>T1110.001</id>
      <id>T1021.001</id>
    </mitre>
    <group>authentication_failed,rdp,pci_dss_10.2.4,pci_dss_10.2.5,gdpr_IV_35.7.d,hipaa_164.312.b,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3</group>
  </rule>

  <!-- ──────────────────────────────────────────────────────────────
       Rule 100002 — RDP Brute Force Detected (Frequency Threshold)
       Fires when rule 100001 triggers 5 or more times from the
       same source IP within a 60-second sliding window.

       Parameters explained:
         frequency="5"    → alert after the 5th matching event
         timeframe="60"   → reset the counter every 60 seconds
         same_source_ip   → group events by attacker IP address
         level="10"       → High severity (scale: 0–15)

       Level 10 in Wazuh = "Multiple authentication failures"
       This level is visible in the Security Events dashboard
       and can trigger active-response scripts.
       ────────────────────────────────────────────────────────────── -->
  <rule id="100002" level="10" frequency="5" timeframe="60">
    <if_matched_sid>100001</if_matched_sid>
    <same_source_ip />
    <description>RDP Brute Force Attack Detected: $(win.eventdata.ipAddress) made $(win.eventdata.failureCount) failed login attempts in 60 seconds against account: $(win.eventdata.targetUserName)</description>
    <options>no_full_log</options>
    <mitre>
      <id>T1110.001</id>
      <id>T1021.001</id>
    </mitre>
    <group>authentication_failures,brute_force,pci_dss_10.2.4,pci_dss_10.2.5,pci_dss_11.4,gdpr_IV_35.7.d,gdpr_IV_32.2,hipaa_164.312.b,nist_800_53_SI.2,nist_800_53_AU.14,nist_800_53_AC.7,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3</group>
  </rule>

  <!-- ──────────────────────────────────────────────────────────────
       Rule 100003 — Sustained RDP Brute Force (Escalation)
       Escalation rule: fires when rule 100002 has triggered 3
       times against the same source IP within 5 minutes.
       This indicates a persistent, ongoing attack rather than
       a brief automated scan. Level 14 = Critical.
       ────────────────────────────────────────────────────────────── -->
  <rule id="100003" level="14" frequency="3" timeframe="300">
    <if_matched_sid>100002</if_matched_sid>
    <same_source_ip />
    <description>CRITICAL: Sustained RDP Brute Force Attack in progress from $(win.eventdata.ipAddress). Immediate block recommended. Review windows-firewall-block.ps1.</description>
    <options>no_full_log</options>
    <mitre>
      <id>T1110.001</id>
      <id>T1021.001</id>
    </mitre>
    <group>authentication_failures,brute_force,high_volume</group>
  </rule>

</group>
